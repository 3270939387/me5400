# Delta_q 数据分析报告：证明"保守的、坐标下降式策略"

## 执行摘要

本报告通过统计分析 `expert_data` 中的 `delta_q` 数据，证明了模型学到的是**"保守的、近似坐标下降（coordinate descent）式的策略"**，这解释了为什么在线评估时机器人移动很慢。

---

## 证据1: 动作幅度小（平均 |Δq| ≈ 0.005 rad）

### 数据

**每个关节的 |Δq| 统计（基于 3,640 个样本）：**

| 关节 | 均值 (rad) | 均值 (度) | 中位数 (rad) | 最大值 (rad) |
|------|-----------|----------|------------|------------|
| Joint 1 | 0.005544 | 0.3176° | 0.004178 | 0.035823 |
| Joint 2 | 0.004107 | 0.2353° | 0.003232 | 0.023379 |
| Joint 3 | 0.005017 | 0.2874° | 0.004244 | 0.043181 |
| Joint 4 | 0.004802 | 0.2751° | 0.003982 | 0.044997 |
| Joint 5 | 0.006512 | 0.3731° | 0.004815 | 0.042089 |
| Joint 6 | 0.005681 | 0.3255° | 0.005004 | 0.031330 |
| Joint 7 | 0.008085 | 0.4632° | 0.005892 | 0.044111 |
| **总体平均** | **0.005678** | **0.3253°** | - | - |

### 解释

1. **数值证明**：
   - 所有关节的平均 |Δq| = **0.005678 rad = 0.3253°**
   - 这是一个**非常小的角度变化**（约 0.33 度）

2. **对比参考**：
   - 正常的手臂运动通常需要**几度到几十度**的变化
   - 例如：抬起手臂可能需要 30-60° 的关节变化
   - 当前数据中的动作幅度仅为正常运动的 **1-2%**

3. **影响**：
   - 这种"微调"级别的动作会导致机器人移动非常缓慢
   - 如果每步只移动 0.33°，要完成 30° 的位移需要约 **90 步**
   - 在 200 步的 episode 中，只能完成约 **66°** 的总位移（如果只移动一个关节）

### 具体示例

**示例样本（Episode 0, Step 5）：**
```
Joint 1: -0.016440 rad (-0.942°)  ← 最大，但也很小
Joint 2: -0.006238 rad (-0.357°)
Joint 3: -0.003981 rad (-0.228°)
Joint 4: -0.003433 rad (-0.197°)
Joint 5:  0.007617 rad ( 0.436°)
Joint 6:  0.000529 rad ( 0.030°)
Joint 7:  0.008914 rad ( 0.511°)
```
- 最大动作：0.016 rad ≈ **0.94°**（仍然很小）

---

## 证据2: 稀疏性高（86.9% 的样本只有 1–2 个关节显著移动）

### 数据

**显著非零关节数量分布（阈值 ε = 0.01 rad）：**

| 非零关节数 | 样本数 | 占比 | 可视化 |
|-----------|--------|------|--------|
| 0 个关节 | 1,397 | 38.4% | ███████████████████ |
| 1 个关节 | 982 | 27.0% | █████████████ |
| 2 个关节 | 785 | 21.6% | ██████████ |
| 3 个关节 | 335 | 9.2% | ████ |
| 4 个关节 | 102 | 2.8% | █ |
| 5 个关节 | 39 | 1.1% | |
| **总计** | **3,640** | **100%** | |

**关键统计：**
- **只有 1–2 个关节显著非零的样本：1,767 (48.5%)**
- **只有 0–2 个关节显著非零的样本：3,164 (86.9%)**

### 解释

1. **稀疏性定义**：
   - 如果 |Δq_i| > 0.01 rad，认为该关节"显著非零"
   - 0.01 rad ≈ 0.57°，这是一个合理的阈值（大于噪声水平）

2. **数据证明**：
   - **86.9%** 的样本只有 0–2 个关节显著移动
   - **48.5%** 的样本只有 1–2 个关节显著移动
   - 只有 **13.1%** 的样本有 3+ 个关节同时显著移动

3. **坐标下降特征**：
   - **坐标下降（Coordinate Descent）**：每次只优化一个或少数几个变量
   - 当前数据表现出明显的坐标下降特征：
     - 大部分时候只移动 1–2 个关节
     - 其他关节保持相对静止

4. **对比**：
   - **多关节协调**：所有 7 个关节同时移动，每个关节贡献约 1/7 ≈ 14.3% 的总动作
   - **坐标下降**：1–2 个关节承担大部分动作，其他关节几乎不动
   - 当前数据更接近后者

### 具体示例

**示例1：单关节主导（Episode 0, Step 5）**
```
Joint 1: -0.016440 rad (0.942°) ✓  ← 唯一显著非零
Joint 2: -0.006238 rad (0.357°)
Joint 3: -0.003981 rad (0.228°)
...
显著非零关节数: 1
```

**示例2：双关节协调（Episode 0, Step 10）**
```
Joint 1: -0.016367 rad (0.938°) ✓
Joint 7:  0.010105 rad (0.579°) ✓  ← 只有这两个显著非零
...
显著非零关节数: 2
```

---

## 证据3: 平均只有 1.14 个关节显著非零

### 数据

**显著非零关节数量的统计量：**

| 统计量 | 值 |
|--------|-----|
| **均值** | **1.14 个关节** |
| 中位数 | 1.00 个关节 |
| 标准差 | 1.17 个关节 |
| 最小值 | 0 个关节 |
| 最大值 | 5 个关节 |

### 解释

1. **均值 1.14 的含义**：
   - 平均每个样本只有 **1.14 个关节**在显著移动
   - 这意味着大部分时候，**只有 1 个关节在动**，其他 6 个关节几乎静止

2. **中位数 1.00 的含义**：
   - 中位数是 1，说明**超过一半的样本只有 0–1 个关节在动**
   - 这进一步证明了数据的稀疏性

3. **标准差 1.17 的含义**：
   - 标准差较大，说明不同样本之间的差异较大
   - 但即使是最"活跃"的样本，平均也只有约 2.3 个关节显著非零（均值 + 1 标准差）

4. **与理论值的对比**：
   - 如果是"多关节协调"策略，平均应该有 **3–4 个关节**同时显著非零
   - 如果是"完全坐标下降"策略，平均应该有 **1 个关节**显著非零
   - 当前数据（1.14）更接近"完全坐标下降"

---

## 综合结论

### 三个证据的一致性

1. **动作幅度小**（0.0057 rad ≈ 0.33°）
   - 每步移动很小
   - 需要很多步才能完成较大位移

2. **稀疏性高**（86.9% 的样本只有 0–2 个关节显著非零）
   - 大部分时候只移动 1–2 个关节
   - 其他关节保持相对静止

3. **平均显著非零关节数低**（1.14 个）
   - 平均只有 1 个关节在显著移动
   - 进一步证明了坐标下降特征

### 对模型行为的影响

如果模型学到了这种模式，它会：

1. **预测较小的 delta_q**（保守）
   - 模型会学习到"动作应该很小"的模式
   - 预测的 delta_q 会接近训练数据的分布（约 0.005 rad）

2. **每次主要移动一个关节**（坐标下降）
   - 模型会学习到"每次只调整少数关节"的模式
   - 预测的 delta_q 中，大部分关节的值会很小

3. **导致在线评估时移动很慢**
   - 每步移动很小（约 0.33°）
   - 每次只移动 1 个关节
   - 需要很多步才能完成较大位移
   - 在 200 步的 episode 中，可能无法到达目标

### 可视化图表

分析脚本已生成以下可视化图表（保存在 `expert_data/delta_q_analysis/`）：

1. **`joint_abs_delta_q_boxplot.png`**：每个关节的 |Δq| 分布（箱线图）
2. **`max_joint_ratio_hist.png`**：最大关节幅值占比分布
3. **`non_zero_joint_count_dist.png`**：非零关节数量分布
4. **`joint_means_with_std.png`**：每个关节的均值对比（带标准差）

---

## 建议

基于这些分析，建议：

1. **增加数据多样性**：
   - 采集更多"多关节协调"的轨迹
   - 增加动作幅度更大的样本

2. **调整数据收集策略**：
   - 降低 `CAPTURE_EVERY_N`（例如改为每 1–2 步）
   - 捕获更细粒度的动作

3. **考虑动作缩放**：
   - 在评估时适度放大动作（但需要谨慎，避免不稳定）

4. **使用速度控制**：
   - 将 `delta_q` 转换为速度命令，可能更平滑

---

## 数据来源

- **数据集**：`/home/alphatok/ME5400/expert_data`
- **总样本数**：3,640
- **Episodes 数**：91
- **分析脚本**：`/home/alphatok/ME5400/training/analyze_delta_q.py`

